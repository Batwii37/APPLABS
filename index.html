<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GameStore Pro</title>
<style>
body { font-family: Arial; margin:0; padding:20px; background:#111; color:white; }
h1,h2 { color:#ffdd00; }
.card { border:1px solid #444; padding:12px; margin-top:10px; border-radius:8px; background:#222; }
input, button { padding:8px; margin:4px; border-radius:4px; border:none; }
button { cursor:pointer; background:#ffdd00; color:#111; font-weight:bold; }
button:hover { background:#ffaa00; }
#adminSidebar { position:fixed; right:0; top:0; width:300px; height:100%; background:#222; border-left:1px solid #444; padding:20px; overflow-y:auto; z-index:1000; }
</style>
</head>
<body>

<h1>ðŸŽ® GameStore Pro</h1>

<h2>Store</h2>
<button onclick="loadGames()">Refresh Store</button>
<div id="games"></div>

<hr>

<h2>Upload Game</h2>
<input id="title" placeholder="Game title"><br>
<input id="desc" placeholder="Description"><br>
<input id="price" placeholder="Price"><br>
<input id="email" placeholder="Your email"><br>
<input id="file" type="file" accept=".apk"><br>
<button onclick="uploadGame()">Upload Game</button>
<div id="uploadStatus"></div>

<hr>

<h2>Admin Login</h2>
<input id="adminEmail" placeholder="Admin email"><br>
<input id="adminKey" placeholder="Admin key"><br>
<button onclick="checkAdmin()">Enter Admin</button>
<div id="adminStatus"></div>

<script>
const API = "http://localhost:3000";
const ADMIN_EMAIL = "stormywilliams279@gmail.com";
const ADMIN_KEY = "SuperSecret123";
let isAdminLoggedIn = false;

// ---------------- Load Approved Games ----------------
async function loadGames(){
  try{
    const res = await fetch(API+"/store");
    const games = await res.json();
    const el = document.getElementById("games");
    el.innerHTML = "";
    games.forEach(g => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `<h3>${g.title}</h3><p>${g.description}</p><b>$${g.price}</b>`;
      el.appendChild(div);
    });
  } catch(err){
    console.error("Error loading games:", err);
  }
}

// ---------------- Upload Game (User) ----------------
async function uploadGame(){
  const fileInput = document.getElementById("file");
  if(!fileInput.files[0]){ alert("Select a file!"); return; }

  const form = new FormData();
  form.append("title", document.getElementById("title").value);
  form.append("description", document.getElementById("desc").value);
  form.append("price", document.getElementById("price").value);
  form.append("developerEmail", document.getElementById("email").value);

  try{
    const res = await fetch(API+"/upload-game",{method:"POST",body:form});
    const data = await res.json();
    document.getElementById("uploadStatus").innerText = data.success ? data.message : "Error: " + data.error;
    fileInput.value="";

    // Reload store if admin uploaded or auto-update after approval (for demo)
    loadGames();
  } catch(err){
    document.getElementById("uploadStatus").innerText = "Upload error: " + err.message;
  }
}

// ---------------- Admin Login ----------------
function checkAdmin(){
  const email = document.getElementById("adminEmail").value;
  const key = document.getElementById("adminKey").value;

  if(email === ADMIN_EMAIL && key === ADMIN_KEY){
    isAdminLoggedIn = true;
    document.getElementById("adminStatus").innerText = "Admin verified!";

    // Dynamically create admin panel
    if(!document.getElementById("adminSidebar")){
      const sidebar = document.createElement("div");
      sidebar.id = "adminSidebar";

      sidebar.innerHTML = `
        <h2>Admin Panel</h2>
        <h3>Pending Games</h3>
        <button onclick="loadPending()">Refresh Pending</button>
        <div id="pending"></div>
        <hr>
        <h3>Admin Upload</h3>
        <input id="adminTitle" placeholder="Game title"><br>
        <input id="adminDesc" placeholder="Description"><br>
        <input id="adminPrice" placeholder="Price"><br>
        <input id="adminFile" type="file" accept=".apk"><br>
        <button onclick="adminUploadGame()">Upload Game</button>
        <div id="adminUploadStatus"></div>
      `;
      document.body.appendChild(sidebar);
      loadPending();
    }
  } else {
    alert("Incorrect admin email or key.");
  }
}

// ---------------- Load Pending Games ----------------
async function loadPending(){
  if(!isAdminLoggedIn) return;
  try{
    const res = await fetch(API+"/pending");
    const games = await res.json();
    const el = document.getElementById("pending");
    el.innerHTML = "";
    games.forEach(g => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `<h4>${g.title}</h4><p>${g.description}</p><button onclick="verifyGame('${g.id}')">Verify</button>`;
      el.appendChild(div);
    });
  } catch(err){ console.error("Error loading pending:", err); }
}

// ---------------- Verify Game ----------------
async function verifyGame(id){
  if(!isAdminLoggedIn) return;
  try{
    const res = await fetch(API+"/verify-game/"+id,{
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({email: ADMIN_EMAIL, key: ADMIN_KEY})
    });
    const data = await res.json();
    if(!data.success) alert("Error: "+data.error);

    // Reload pending and store after verification
    loadPending();
    loadGames();
  } catch(err){ console.error("Error verifying game:", err); }
}

// ---------------- Admin Upload Direct ----------------
async function adminUploadGame(){
  if(!isAdminLoggedIn){ alert("Login as admin first!"); return; }

  const fileInput = document.getElementById("adminFile");
  if(!fileInput.files[0]){ alert("Select a file!"); return; }

  const form = new FormData();
  form.append("title", document.getElementById("adminTitle").value);
  form.append("description", document.getElementById("adminDesc").value);
  form.append("price", document.getElementById("adminPrice").value);
  form.append("developerEmail", ADMIN_EMAIL);
  form.append("isAdmin", "true");

  try{
    const res = await fetch(API+"/upload-game",{method:"POST",body:form});
    const data = await res.json();
    document.getElementById("adminUploadStatus").innerText = data.success ? data.message : "Error: "+data.error;
    fileInput.value="";
    
    // Reload store so admin uploads appear immediately
    loadGames();
  } catch(err){ document.getElementById("adminUploadStatus").innerText = "Upload error: "+err.message; }
}

// Initial load
loadGames();
</script>

</body>
</html>
